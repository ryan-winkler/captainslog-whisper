#!/usr/bin/env bash
# captainslog â€” CLI interface for Captain's Log speech-to-text
# Wraps the HTTP API for use by ZeroClaw, scripts, and automation.
#
# Usage:
#   captainslog transcribe <file>         Transcribe audio/video file â†’ stdout
#   captainslog save <text>               Save text to Obsidian vault
#   captainslog stardate                  Print current stardate
#   captainslog health                    Check backend status
#   captainslog settings                  Show current settings
#   captainslog settings <key> <value>    Update a setting
#   captainslog models                    List available Whisper/Ollama models
#   captainslog history                   Show recent transcription history
#
# Environment:
#   CAPTAINSLOG_URL   Base URL (default: http://127.0.0.1:8090)
#   CAPTAINSLOG_TOKEN Auth token (optional)

set -euo pipefail

BASE_URL="${CAPTAINSLOG_URL:-http://127.0.0.1:8090}"
TOKEN="${CAPTAINSLOG_TOKEN:-}"

# Auth header if token is set
auth_header() {
    if [[ -n "$TOKEN" ]]; then
        echo "-H" "Authorization: Bearer $TOKEN"
    fi
}

cmd="${1:-help}"
shift || true

case "$cmd" in
    transcribe|t)
        # Transcribe an audio/video file
        file="${1:-}"
        if [[ -z "$file" || ! -f "$file" ]]; then
            echo "Usage: captainslog transcribe <file>" >&2
            exit 1
        fi
        format="${2:-text}"
        lang="${CAPTAINSLOG_LANGUAGE:-}"
        
        args=(-s -X POST "${BASE_URL}/v1/audio/transcriptions")
        args+=(-F "file=@${file}")
        args+=(-F "response_format=${format}")
        [[ -n "$lang" ]] && args+=(-F "language=${lang}")
        [[ -n "$TOKEN" ]] && args+=(-H "Authorization: Bearer $TOKEN")
        
        result=$(curl "${args[@]}" 2>/dev/null)
        
        if [[ "$format" == "json" || "$format" == "verbose_json" ]]; then
            echo "$result" | python3 -m json.tool 2>/dev/null || echo "$result"
        elif [[ "$format" == "text" ]]; then
            # text format returns plain text, json returns {"text": "..."}
            if echo "$result" | python3 -c "import sys,json; print(json.load(sys.stdin)['text'])" 2>/dev/null; then
                :
            else
                echo "$result"
            fi
        else
            echo "$result"
        fi
        ;;

    save|s)
        # Save text to vault
        text="${*}"
        if [[ -z "$text" ]]; then
            # Read from stdin if no args
            text=$(cat)
        fi
        if [[ -z "$text" ]]; then
            echo "Usage: captainslog save <text>" >&2
            echo "  or:  echo 'text' | captainslog save" >&2
            exit 1
        fi
        
        lang="${CAPTAINSLOG_LANGUAGE:-en}"
        payload=$(python3 -c "import json; print(json.dumps({'text': '''${text}''', 'language': '${lang}'}))" 2>/dev/null || \
                  printf '{"text":"%s","language":"%s"}' "$(echo "$text" | sed 's/"/\\"/g')" "$lang")
        
        curl -s -X POST "${BASE_URL}/api/vault/save" \
            -H "Content-Type: application/json" \
            $(auth_header) \
            -d "$payload" | python3 -m json.tool 2>/dev/null || echo "Save failed"
        ;;

    stardate|sd)
        # Print current stardate
        data=$(curl -s "${BASE_URL}/api/stardate" 2>/dev/null)
        if [[ "${1:-}" == "--json" || "${1:-}" == "-j" ]]; then
            echo "$data" | python3 -m json.tool 2>/dev/null || echo "$data"
        else
            echo "$data" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['formatted'])" 2>/dev/null || echo "$data"
        fi
        ;;

    health|h)
        # Check backend health
        curl -s "${BASE_URL}/healthz" | python3 -m json.tool 2>/dev/null
        ;;

    settings|config)
        if [[ $# -eq 0 ]]; then
            # Show all settings
            curl -s "${BASE_URL}/api/settings" | python3 -m json.tool 2>/dev/null
        elif [[ $# -eq 1 ]]; then
            # Get single setting
            key="$1"
            curl -s "${BASE_URL}/api/settings" | python3 -c "import sys,json; print(json.load(sys.stdin).get('$key', 'not found'))" 2>/dev/null
        else
            # Update setting: captainslog settings language fr
            key="$1"
            value="$2"
            # Handle booleans
            if [[ "$value" == "true" || "$value" == "false" ]]; then
                payload="{\"$key\": $value}"
            else
                payload="{\"$key\": \"$value\"}"
            fi
            curl -s -X PUT "${BASE_URL}/api/settings" \
                -H "Content-Type: application/json" \
                -d "$payload" | python3 -m json.tool 2>/dev/null
        fi
        ;;

    models|m)
        # List available models
        curl -s "${BASE_URL}/api/models" | python3 -c "
import sys, json
data = json.load(sys.stdin)
print('Whisper models:')
for m in data.get('whisper', []):
    print(f'  {m[\"id\"]:20s} {m.get(\"name\", \"\")}')
if data.get('ollama'):
    print('Ollama models:')
    for m in data['ollama']:
        print(f'  {m[\"id\"]:20s} {m.get(\"name\", \"\")}')
" 2>/dev/null
        ;;

    history)
        # Note: history is stored in browser localStorage, not server-side
        echo "Transcription history is stored in the browser (localStorage)."
        echo "Use the web UI at ${BASE_URL} to view history."
        echo ""
        echo "For CLI history, pipe transcriptions through tee:"
        echo "  captainslog transcribe recording.wav | tee -a ~/captainslog.txt"
        ;;

    help|--help|-h|"")
        cat <<'EOF'
ðŸ–– Captain's Log CLI â€” Local Speech-to-Text

Usage:
  captainslog transcribe <file> [format]   Transcribe file (text|json|srt|vtt)
  captainslog save <text>                  Save to Obsidian vault
  captainslog stardate [-j]                Current stardate (--json for full)
  captainslog health                       Backend status
  captainslog settings [key] [value]       View/update settings
  captainslog models                       List available models
  captainslog history                      Transcription history info

Examples:
  captainslog transcribe meeting.mp3
  captainslog transcribe interview.wav json
  captainslog save "Meeting notes from standup"
  echo "dictated text" | captainslog save
  captainslog stardate
  captainslog settings language fr
  captainslog settings auto_save true

Environment:
  CAPTAINSLOG_URL      API base URL (default: http://127.0.0.1:8090)
  CAPTAINSLOG_TOKEN    Auth token (if server requires auth)
  CAPTAINSLOG_LANGUAGE Default language for transcription
EOF
        ;;

    *)
        echo "Unknown command: $cmd" >&2
        echo "Run 'captainslog help' for usage" >&2
        exit 1
        ;;
esac
